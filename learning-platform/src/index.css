@import "tailwindcss";
@import "katex/dist/katex.min.css";

/* ============================================================================
   SAFE AREA INSETS - iOS Notch & Dynamic Island Support
   ============================================================================

   These CSS variables provide safe area padding for iOS devices with:
   - Notch (iPhone X, 11, 12, 13)
   - Dynamic Island (iPhone 14 Pro, 15 Pro)

   Usage:
   - Use Tailwind utilities: pt-safe-t, pb-safe-b, pl-safe-l, pr-safe-r
   - Or use CSS variables directly: padding-top: var(--safe-top);

   Fallback to 0px on devices without notches/dynamic island.
   ============================================================================ */
:root {
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
}

/* ============================================================================
   REDUCED MOTION - Accessibility Support
   ============================================================================

   Disable or reduce animations for users who prefer reduced motion.
   Respects system setting: Settings > Accessibility > Motion > Reduce Motion

   This helps users with:
   - Vestibular disorders
   - Motion sickness
   - Preference for calmer UI
   ============================================================================ */
@media (prefers-reduced-motion: reduce) {

  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

@layer base {
  html {
    font-family: Georgia, "Times New Roman", Times, serif;
  }

  body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
}

@layer utilities {
  .glass-surface {
    position: relative;
    z-index: 0;
  }

  .glass-surface::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
    z-index: -1;
    background:
      radial-gradient(120% 70% at 20% 0%, rgba(255, 255, 255, 0.14) 0%, rgba(255, 255, 255, 0.06) 32%, transparent 62%),
      linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, transparent 45%);
    opacity: 0.9;
  }

  .glass-surface::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
    z-index: -1;
    border: 1px solid rgba(255, 255, 255, 0.08);
    opacity: 0.6;
  }

  /* Light theme glass needs more edge contrast to read as frosted */
  [data-theme='light'] .glass-surface::before {
    background:
      radial-gradient(120% 70% at 18% 0%, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.55) 26%, transparent 62%),
      radial-gradient(120% 90% at 85% 100%, rgba(0, 0, 0, 0.12) 0%, transparent 55%),
      radial-gradient(110% 70% at 0% 55%, rgba(217, 119, 87, 0.18) 0%, transparent 55%),
      radial-gradient(120% 80% at 100% 15%, rgba(88, 101, 242, 0.14) 0%, transparent 58%),
      linear-gradient(135deg, rgba(255, 255, 255, 0.38) 0%, transparent 52%),
      repeating-linear-gradient(135deg, rgba(0, 0, 0, 0.018) 0px, rgba(0, 0, 0, 0.018) 1px, transparent 1px, transparent 4px);
    opacity: 0.85;
  }

  [data-theme='light'] .glass-surface::after {
    border-color: rgba(0, 0, 0, 0.10);
    opacity: 0.55;
  }

  .scroll-smooth {
    scroll-behavior: smooth;
  }

  .message-appear {
    animation: messageAppear 0.3s ease-out;
  }

  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.95);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Mobile drawer slide-in animation */
  @keyframes slideInFromLeft {
    from {
      transform: translateX(-100%);
    }

    to {
      transform: translateX(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  .pulse-glow {
    animation: pulseGlow 2s infinite;
  }

  @keyframes pulseGlow {

    0%,
    100% {
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
    }

    50% {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4);
    }
  }

  /* ============================================================================
     MATHTEXT LIST STYLING FIX
     ============================================================================

     PROBLEM SOLVED:
     When markdown lists contain LaTeX math expressions, browser default <li>
     styling causes LaTeX to break onto separate lines.

     Example Input (from AI-generated question):
       * Length (AB) = $15\text{ cm}$
       * Width (BC) = $10\text{ m}$

     Without this fix, renders as:
       ‚Ä¢ Length (AB) =
         15 cm              ‚Üê LaTeX on new line (BAD - reported by user)
       ‚Ä¢ Width (BC) =
         10 m

     With this fix, renders as:
       ‚Ä¢ Length (AB) = 15 cm   ‚Üê LaTeX inline (GOOD)
       ‚Ä¢ Width (BC) = 10 m

     ROOT CAUSE:
     1. MathText.tsx extracts LaTeX: "* Length = ‚ü®‚ü®MATH0‚ü©‚ü©"
     2. marked.parse() converts to: "<li>Length = ‚ü®‚ü®MATH0‚ü©‚ü©</li>"
     3. Browser default <li> has display:list-item with line breaks
     4. Result: text and math render on different lines

     IMPLEMENTATION:
     - Applied via .math-text-with-lists class in MathText.tsx (line 141)
     - Only active when hasBlockMarkdown=true (lists, headers, etc.)
     - Reduces spacing while maintaining readability and accessibility

     HISTORY:
     - Added: January 2025
     - Issue: User reported "extra line breaks in list items with LaTeX"
     - Debug: Check MathText.tsx console for "üîç MathText block markdown detected"
     - Related: MathText.tsx lines 109-141 (comprehensive comment block)

     TESTING:
     To verify this fix works, test with:
       "* Length = $15\text{ cm}$\n* Width = $10\text{ m}$"
     Should render as compact list with math inline, not separate lines.

     DO NOT REMOVE without testing the above case first!
     ============================================================================ */

  .math-text-with-lists ul,
  .math-text-with-lists ol {
    margin: 0.5em 0;
    /* Reduced from browser default ~1em */
    padding-left: 1.5em;
    /* Standard indent for bullets */
    line-height: 1.6;
    /* Comfortable reading line height */
  }

  .math-text-with-lists li {
    margin: 0.25em 0;
    /* Minimal spacing between list items */
    line-height: 1.6;
    /* Match parent line-height */
  }

  /* Ensure KaTeX (LaTeX renderer) inside list items displays inline */
  .math-text-with-lists li .katex {
    display: inline;
    /* Force inline, override any block defaults */
    margin: 0;
    /* No extra margin around math expressions */
  }

  /* ============================================================================
     MARKDOWN TABLE STYLING
     ============================================================================

     Tables are used in educational content for:
     - Place value charts (P5 Numbers to 10 Million)
     - Data representation
     - Comparison tables

     These styles ensure tables are readable and visually appealing.
     ============================================================================ */

  .math-text-with-lists table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
    font-size: 0.95em;
  }

  .math-text-with-lists th,
  .math-text-with-lists td {
    border: 1px solid #e5e7eb;
    padding: 0.75em 1em;
    text-align: left;
  }

  .math-text-with-lists th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #374151;
  }

  .math-text-with-lists tr:nth-child(even) {
    background-color: #f9fafb;
  }

  .math-text-with-lists tr:hover {
    background-color: #f3f4f6;
  }

  /* Dark mode table styling */
  .dark .math-text-with-lists th,
  .dark .math-text-with-lists td {
    border-color: #374151;
  }

  .dark .math-text-with-lists th {
    background-color: #1f2937;
    color: #f3f4f6;
  }

  .dark .math-text-with-lists tr:nth-child(even) {
    background-color: #1f2937;
  }

  .dark .math-text-with-lists tr:hover {
    background-color: #374151;
  }

  /* ============================================================================
     INLINE MATH WRAPPING FIX
     ============================================================================

     PROBLEM SOLVED:
     Inline math expressions like $\sin(A)$ were wrapping to a new line when they
     appeared at the end of long sentences.

     Example: "what is the value of $\sin(A)$?"
     Without fix: "what is the value of"  (line break here)
                  "sin(A)?"
     With fix: "what is the value of sin(A)?" (stays together)

     SOLUTION:
     - Keep inline math with preceding word using white-space
     - Allow wrapping if math+context is too long
     ============================================================================ */

  /* Force ALL KaTeX elements to inherit font for consistent appearance */
  .katex,
  .katex * {
    font-family: inherit !important;
  }

  .katex {
    display: inline !important;
    /* Ensure KaTeX is always inline, not block */
    font-size: inherit !important;
    /* Match surrounding text size */
  }

  /* Increase size ONLY for complex math elements (fractions, radicals) */
  .katex .mfrac,
  .katex .sqrt {
    font-size: 1.25em;
    /* Make fractions and square roots 25% larger for readability */
  }

  /* Prevent double-scaling for nested elements (e.g. fraction inside sqrt) */
  .katex .mfrac .mfrac,
  .katex .mfrac .sqrt,
  .katex .sqrt .mfrac,
  .katex .sqrt .sqrt {
    font-size: 1em;
  }

  /* Prevent awkward line breaks before/within inline math */
  .math-renderer {
    display: inline-block;
    /* Prevent line breaks before math - treat as atomic unit */
    white-space: nowrap;
    /* Prevent breaking within the math expression */
    vertical-align: baseline;
    /* Align with text baseline for proper positioning */
  }

  /* Try to keep math with preceding text - DISABLED: Causes unwanted line breaks
  span:has(> .math-renderer) {
    display: inline-block;             
  }
  */

  /* ============================================================================
     SCRATCH PAD - RESPONSIVE GRID LAYOUT
     ============================================================================

     Desktop/Tablet (‚â•1024px): Side-by-side layout with problem on left (60%),
     scratch pad on right (40%). Scratch pad is sticky and scrolls independently.

     Mobile (<1024px): Stacked layout with scratch pad below problem card.
     Scratch pad is collapsible to save screen space.
     ============================================================================ */

  .grid-layout-responsive {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: 1fr;
    /* Mobile: stacked */
  }

  @media (min-width: 1024px) {
    .grid-layout-responsive {
      grid-template-columns: 58% 1fr;
      /* Desktop: problem column takes 58%, scratch pad is fixed positioned */
      align-items: start;
    }

    .scratch-pad-column {
      position: fixed;
      top: 6rem; /* Account for fixed header height (96px) */
      right: max(1rem, calc((100vw - 80rem) / 2 + 1rem)); /* Align with max-w-7xl container */
      width: min(38%, 480px); /* 38% width with max cap */
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
      z-index: 40;
    }
  }

  /* ============================================================================
     SCRATCH PAD - VISUAL EFFECTS
     ============================================================================ */

  /* Grid paper background for drawing canvas */
  .canvas-grid-bg {
    background-color: #ffffff;
    background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px);
    background-size: 20px 20px;
  }

  /* Lined paper effect for text mode */
  .text-lined-bg {
    background-color: #ffffff;
    background-image: repeating-linear-gradient(transparent,
        transparent 24px,
        #e5e7eb 24px,
        #e5e7eb 25px);
  }

  /* Smooth scrollbar for scratch pad on desktop */
  @media (min-width: 1024px) {
    .scratch-pad-column::-webkit-scrollbar {
      width: 8px;
    }

    .scratch-pad-column::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    .scratch-pad-column::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .scratch-pad-column::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  }

  /* ============================================================================
     RESPONSIVE IMAGES - Mobile Optimization
     ============================================================================

     Make all images inside messages responsive on mobile.
     Prevents visualizations (like unit circles) from overflowing on small screens.
     ============================================================================ */

  /* Only make message images responsive, not all images */
  .visualization-in-message img,
  .visualization-in-message svg,
  .math-text-with-lists img {
    max-width: 100% !important;
    width: 100% !important;
    height: auto !important;
  }

  /* Ensure message containers don't overflow on mobile */
  @media (max-width: 768px) {
    .visualization-in-message {
      max-width: 100%;
      overflow-x: auto;
      overflow-y: visible;
    }
  }
}
