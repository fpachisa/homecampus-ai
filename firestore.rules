rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isParent(childId) {
      // Check if parent's UID is in child's parents array (for child profiles)
      let hasParentArray = isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(childId)) &&
        get(/databases/$(database)/documents/users/$(childId)).data.parents.hasAny([request.auth.uid]);

      // OR check if child is in parent's children subcollection (for linked children)
      let hasChildSubcollection = isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)/children/$(childId));

      return hasParentArray || hasChildSubcollection;
    }

    function isAdmin() {
      return isAuthenticated() &&
        request.auth.token.admin == true;
    }

    // Validate progress update structure
    function validateProgressUpdate() {
      return request.resource.data.keys().hasAll(['lastUpdated', 'messages']) &&
             request.resource.data.messages is list &&
             request.resource.data.messages.size() < 1500; // Prevent abuse
    }

    // Helper function to check if user is creating a child profile for themselves
    function isCreatingChildProfile() {
      return request.resource.data.accountType == 'child-profile' &&
             request.resource.data.parents.hasAny([request.auth.uid]) &&
             request.resource.data.parentUid == request.auth.uid;
    }

    // User data - new hybrid collection structure
    match /users/{userId} {
      // Main user profile document
      allow read: if isOwner(userId) || isParent(userId);

      // Allow create if owner OR if parent is creating a child profile
      allow create: if isOwner(userId) || isCreatingChildProfile();

      // Allow update if owner OR if parent (for updating child profile stats)
      allow update: if isOwner(userId) || isParent(userId);

      // Only owner can delete
      allow delete: if isOwner(userId);

      // Parent-child relationship subcollections
      match /parents/{parentId} {
        allow read: if isOwner(userId) || request.auth.uid == parentId;
        allow write: if isOwner(userId) || request.auth.uid == parentId;
      }

      match /children/{childId} {
        allow read: if isOwner(userId) || request.auth.uid == childId;
        allow write: if isOwner(userId) || request.auth.uid == childId;
      }

      // Learn mode conversations (subtopic level: users/{uid}/learn/{subtopicId})
      match /learn/{subtopicId} {
        allow read: if isOwner(userId) || isParent(userId);
        // Allow parent to write for child profiles
        allow write: if (isOwner(userId) || isParent(userId)) && validateProgressUpdate();
      }

      // Practice mode progress (topic level: users/{uid}/practice/{topicId})
      match /practice/{topicId} {
        allow read: if isOwner(userId) || isParent(userId);
        // Allow parent to write for child profiles
        allow write: if isOwner(userId) || isParent(userId);
      }

      // Daily activity tracking (users/{uid}/dailyActivity/{date})
      match /dailyActivity/{date} {
        allow read: if isOwner(userId) || isParent(userId);
        allow write: if isOwner(userId) || isParent(userId);
      }

      // Mastery events (users/{uid}/masteryEvents/{eventId})
      match /masteryEvents/{eventId} {
        allow read: if isOwner(userId) || isParent(userId);
        allow write: if isOwner(userId) || isParent(userId);
      }

      // Homework Helper - Problems (users/{uid}/homeworkProblems/{problemId})
      match /homeworkProblems/{problemId} {
        allow read: if isOwner(userId) || isParent(userId);
        allow create, update: if isOwner(userId) || isParent(userId);
        allow delete: if isOwner(userId);

        // Homework sessions subcollection (users/{uid}/homeworkProblems/{problemId}/sessions/{sessionId})
        match /sessions/{sessionId} {
          allow read: if isOwner(userId) || isParent(userId);
          allow create, update: if isOwner(userId) || isParent(userId);
          allow delete: if isOwner(userId);
        }
      }
    }

    // Progress summaries (denormalized for parent dashboard - single read!)
    // Top-level collection for valid 2-segment paths
    match /progressSummaries/{userId} {
      allow read: if isOwner(userId) || isParent(userId);

      // Allow create/update if owner OR if parent (for updating child profile progress)
      allow create, update: if isOwner(userId) || isParent(userId);

      // Only owner can delete
      allow delete: if isOwner(userId);
    }

    // Parent/Student invite links
    match /invites/{inviteId} {
      // Authenticated users can create invites
      allow create: if isAuthenticated();
      // Anyone can read invites (needed to accept invite)
      allow read: if true;
      // Creator can update/delete, OR recipient can update to accept
      allow update: if isAuthenticated() &&
        (resource.data.fromUid == request.auth.uid ||
         request.resource.data.acceptedByUid == request.auth.uid);
      allow delete: if isAuthenticated() && resource.data.fromUid == request.auth.uid;
    }

    // Email queue for Firebase Email Extension
    match /mail/{mailId} {
      // Authenticated users can create email documents
      allow create: if isAuthenticated();
      // Allow read/update for the extension service account and document creator
      // Extension needs to update with delivery status
      allow read, update: if isAuthenticated();
      // Nobody can delete
      allow delete: if false;
    }

    // Public curriculum metadata (read-only)
    match /curriculum/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // Analytics events (write-only)
    match /analytics/{eventId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if false;
    }

    // ============================================
    // CURRICULUM COLLECTIONS (Public Read)
    // ============================================

    // Subtopic configurations
    // Contains: notesComponent paths, scoring configs, learning objectives
    match /subtopics/{subtopicId} {
      // Public read - anyone can view curriculum
      allow read: if true;

      // Admin write only - content management
      allow write: if isAdmin();
    }

    // Topic metadata (future)
    // Contains: topic-level information, icon, subtopic lists
    match /topics/{topicId} {
      // Public read - anyone can view curriculum
      allow read: if true;

      // Admin write only - content management
      allow write: if isAdmin();
    }

    // ============================================
    // BILLING & SUBSCRIPTION COLLECTIONS
    // ============================================

    // Child profiles with subscriptions (subcollection under users)
    match /users/{userId}/childProfiles/{childId} {
      // Parent can read their children's profiles
      allow read: if isOwner(userId);

      // CREATE: Allow parent to create child profile (Client-side implementation)
      allow create: if isOwner(userId);

      // UPDATE: Allow parent to update, including subscription fields (for manual sync/init)
      allow update: if isOwner(userId);

      // DELETE: Allow owner to delete
      allow delete: if isOwner(userId);
    }

    // Active trials - server-only (used for efficient trial expiration queries)
    match /activeTrials/{trialId} {
      // Allow parent to create trial record for their child
      allow create: if isAuthenticated() && 
                    request.resource.data.parentUid == request.auth.uid;
      allow read, update, delete: if false; // Only allow creation, background process handles the rest
    }

    // Stripe customer mappings - server-only
    match /stripeCustomers/{customerId} {
      allow read, write: if false;
    }

    // Stripe webhook events - server-only (idempotency tracking)
    match /stripeEvents/{eventId} {
      allow read, write: if false;
    }

    // Disputes - admin read only
    match /disputes/{disputeId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
